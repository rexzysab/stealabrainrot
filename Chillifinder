local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TeleportService = game:GetService("TeleportService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local API_URL     = "https://akebdoduevodhsbalajvdpdoagwlbdoshanwpdbs.onrender.com/api/servers"
local MIN_MONEY_M = 10
local POLL_RATE   = 0.01
local SOURCE_NAME = "chilli"

-- =============================================
-- ANTI-JOIN STATE
-- =============================================
local ANTI_JOIN = false  -- Toggle: when true, teleports are blocked

-- =============================================
-- DEDUP / CACHE
-- =============================================
local seenJobIds   = {}
local jobDataCache = {}
local webhookSent  = {}

local joinQueue    = {}
local queueBusy    = false
local currentObfId = nil

local firstPollDone = false

-- =============================================
-- DEBUG CONSOLE
-- =============================================
local Console = Instance.new("ScreenGui")
Console.Name = "DebugConsole"
Console.ResetOnSpawn = false
pcall(function()
    if gethui then Console.Parent = gethui()
    elseif typeof(syn) == "table" and syn.protect_gui then syn.protect_gui(Console); Console.Parent = CoreGui
    else Console.Parent = CoreGui end
end)

local ConsoleFrame = Instance.new("Frame")
ConsoleFrame.Size = UDim2.new(0, 440, 0, 190)
ConsoleFrame.Position = UDim2.new(0, 10, 0, 10)
ConsoleFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
ConsoleFrame.BackgroundTransparency = 0.3
ConsoleFrame.Parent = Console
Instance.new("UICorner", ConsoleFrame).CornerRadius = UDim.new(0, 8)

local ConsoleText = Instance.new("TextLabel")
ConsoleText.Size = UDim2.new(1, -10, 1, -10)
ConsoleText.Position = UDim2.new(0, 5, 0, 5)
ConsoleText.BackgroundTransparency = 1
ConsoleText.TextColor3 = Color3.fromRGB(0, 255, 0)
ConsoleText.Text = "Rexzy Joiner\n"
ConsoleText.TextXAlignment = Enum.TextXAlignment.Left
ConsoleText.TextYAlignment = Enum.TextYAlignment.Top
ConsoleText.Font = Enum.Font.Code
ConsoleText.TextSize = 11
ConsoleText.Parent = ConsoleFrame

local function debugLog(msg)
    print("[Rexzy] " .. tostring(msg))
    ConsoleText.Text = ConsoleText.Text .. "\n" .. os.date("%H:%M:%S") .. " " .. tostring(msg)
    local lines = {}
    for line in ConsoleText.Text:gmatch("[^\n]+") do table.insert(lines, line) end
    if #lines > 16 then
        local t = ""
        for i = #lines - 15, #lines do t = t .. lines[i] .. "\n" end
        ConsoleText.Text = t
    end
end

debugLog("Script init")

-- =============================================
-- CHILLI GUI FINDER
-- =============================================
local chilliTextbox = nil
local chilliButton  = nil

local function safeGetConnections(sig)
    local ok, res = pcall(function() return getconnections(sig) end)
    if ok and type(res) == "table" then return res end
    return nil
end

local function safeFireSignal(signal)
    if not signal then return end
    local cons = safeGetConnections(signal)
    if cons then
        for _, c in ipairs(cons) do
            task.spawn(function()
                if c.Function then pcall(c.Function) elseif type(c) == "function" then pcall(c) end
            end)
        end
        return
    end
    pcall(function()
        if signal.Fire then signal:Fire()
        elseif signal.Invoke then signal:Invoke()
        elseif type(signal) == "function" then signal() end
    end)
end

local function safeSetTextBox(tb, txt)
    if not tb then return end
    pcall(function()
        if tb.Focused then pcall(function() safeFireSignal(tb.Focused) end) end
        tb.Text = tostring(txt)
        if tb.FocusLost then pcall(function() safeFireSignal(tb.FocusLost) end) end
    end)
end

local function ultraFindGUI()
    task.spawn(function()
        while true do
            pcall(function()
                local tempTB, tempBtn
                local roots = {game:GetService("CoreGui"), playerGui}
                for _, root in ipairs(roots) do
                    local lbl
                    for _, v in ipairs(root:GetDescendants()) do
                        if v:IsA("TextLabel") and v.Text:match("Job%-ID Input") then lbl = v; break end
                    end
                    if lbl then
                        local container = lbl.Parent.Parent or lbl.Parent
                        for _, v in ipairs(container:GetDescendants()) do
                            if v:IsA("TextBox") then tempTB = v; break end
                        end
                        for _, v in ipairs(container:GetDescendants()) do
                            if v:IsA("TextButton") and v.Text:match("Join Job%-ID") then tempBtn = v; break end
                        end
                        if not tempBtn then
                            for _, v in ipairs(root:GetDescendants()) do
                                if v:IsA("TextButton") and v.Text:match("Join Job%-ID") then tempBtn = v; break end
                            end
                        end
                    end
                    if tempTB and tempBtn then break end
                end
                if tempTB and tempBtn then chilliTextbox = tempTB; chilliButton = tempBtn end
            end)
            if chilliTextbox and chilliButton then debugLog("Chilli GUI found!"); break end
            task.wait(0.5)
        end
    end)
end

local function chilliJoin(obfJobId)
    if not chilliTextbox or not chilliButton then debugLog("Chilli not ready"); return false end
    debugLog("Chilli join: " .. tostring(obfJobId):sub(1, 16) .. "...")
    pcall(function() safeSetTextBox(chilliTextbox, obfJobId) end)
    task.spawn(function()
        local events = {chilliButton.Activated, chilliButton.MouseButton1Click, chilliButton.MouseButton1Down}
        for _, event in ipairs(events) do
            local cons = safeGetConnections(event)
            if cons then for _, c in ipairs(cons) do if c.Function then pcall(c.Function) end end
            elseif event then pcall(function() safeFireSignal(event) end) end
        end
    end)
    return true
end

ultraFindGUI()

-- =============================================
-- MONEY PARSING
-- =============================================
local function getMoneyInMillions(sd)
    if sd.money_per_second and type(sd.money_per_second) == "number" then
        return sd.money_per_second / 1000000
    end
    if sd.money and type(sd.money) == "string" then
        local s = sd.money
        local num = tonumber(s:match("([%d%.]+)")) or 0
        if s:find("B") then return num * 1000
        elseif s:find("T") then return num * 1000000
        else return num end
    end
    return 0
end

local function formatMoney(m)
    if m >= 1000 then return string.format("%.1fB/s", m / 1000) end
    return string.format("%.1fM/s", m)
end

local function cleanMoneyStr(raw, moneyM)
    local s = tostring(raw or ""):gsub("%$", ""):gsub("%s", "")
    if s == "" then s = formatMoney(moneyM) end
    return s
end

-- =============================================
-- WEBHOOK â€” sends to dcwhook.rexzy.online
-- =============================================
local function sendWebhook(petName, moneyStr, players, rawJobId, pid)
    task.spawn(function()
        pcall(function()
            local req = http_request or request or (syn and syn.request)
            if not req then debugLog("No HTTP func"); return end

            local joinLink = string.format(
                "https://chillihub1.github.io/chillihub-joiner/?placeId=%d&gameInstanceId=%s",
                tonumber(pid) or game.PlaceId,
                rawJobId
            )

            local joinScript = string.format(
                "game:GetService('TeleportService'):TeleportToPlaceInstance(%d, '%s', game.Players.LocalPlayer)",
                tonumber(pid) or game.PlaceId,
                rawJobId
            )

            local currentPlayers = #Players:GetPlayers()
            local maxPlayers = Players.MaxPlayers or 0

            local embed = {
                title = "ðŸŽ¾ " .. (petName or "Unknown") .. " - " .. (moneyStr or "N/A"),
                description = string.format(
                    "**Value:** %s\n**Animal:** %s\n**Players:** %s/%s\nâž¡ï¸ **Join Link:** [Click here](%s)\nâž¡ï¸ **Join Script:** `%s`",
                    moneyStr or "N/A",
                    petName or "Unknown",
                    players or tostring(currentPlayers),
                    tostring(maxPlayers),
                    joinLink,
                    joinScript
                ),
                color = 16776960,
                fields = {
                    { name = "Players",  value = string.format("%s/%s", players or tostring(currentPlayers), tostring(maxPlayers)), inline = true },
                    { name = "Place ID", value = tostring(pid or game.PlaceId),                                                     inline = true },
                    { name = "Server",   value = rawJobId,                                                                          inline = false },
                    { name = "Source",   value = SOURCE_NAME,                                                                       inline = true },
                },
                footer = { text = "Rexzy Notifier" },
                timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
            }

            local payload = HttpService:JSONEncode({
                username   = "Rexzy Notifier",
                avatar_url = "https://i.imgur.com/4W82G1j.png",
                embeds     = { embed }
            })

            local result = req({
                Url     = "https://dcwhook.rexzy.online/send",
                Method  = "POST",
                Headers = { ["Content-Type"] = "application/json" },
                Body    = payload
            })

            debugLog("Webhook: " .. tostring(result and result.StatusCode or "?"))
        end)
    end)
end

-- =============================================
-- TELEPORT HOOK (with Anti-Join)
-- =============================================
local function isRawJobId(str)
    if type(str) ~= "string" then return false end
    return #str == 36 and str:match("^%x%x%x%x%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%x%x%x%x%x%x%x%x$")
end

local oldTeleport
oldTeleport = hookfunction(TeleportService.TeleportToPlaceInstance, function(...)
    local args     = {...}
    local rawJobId = nil
    local pid      = game.PlaceId

    for _, arg in pairs(args) do
        if type(arg) == "number" and arg ~= 0 then pid = arg
        elseif type(arg) == "string" and isRawJobId(arg) then rawJobId = arg end
    end

    if rawJobId and not webhookSent[rawJobId] then
        webhookSent[rawJobId] = true

        local obfId  = currentObfId
        local cached = obfId and jobDataCache[obfId]

        local petName  = cached and cached.name     or "Unknown"
        local moneyStr = cached and cached.moneyStr or "N/A"
        local players  = cached and cached.players  or "?"
        local placeid  = cached and cached.placeId  or pid

        debugLog("âœ… Raw: " .. rawJobId:sub(1, 18) .. " | " .. petName .. " " .. moneyStr)
        sendWebhook(petName, moneyStr, players, rawJobId, placeid)

        queueBusy    = false
        currentObfId = nil
    end

    -- *** ANTI-JOIN: block the actual teleport when enabled ***
    if ANTI_JOIN then
        if rawJobId then
            debugLog("ðŸš« ANTI-JOIN: Teleport blocked for " .. rawJobId:sub(1, 18) .. "...")
        else
            debugLog("ðŸš« ANTI-JOIN: Teleport blocked (no job ID)")
        end
        return  -- Return nothing = teleport never fires
    end

    return oldTeleport(...)
end)

debugLog("Teleport hook active")

-- =============================================
-- QUEUE PROCESSOR
-- =============================================
task.spawn(function()
    while true do
        if not queueBusy and #joinQueue > 0 then
            local entry = table.remove(joinQueue, 1)
            jobDataCache[entry.obfJobId] = {
                name     = entry.name,
                moneyStr = entry.moneyStr,
                players  = entry.players,
                placeId  = entry.placeId
            }
            currentObfId = entry.obfJobId
            queueBusy    = true
            debugLog("Queue join: " .. entry.name .. " | " .. entry.moneyStr .. " [Q=" .. #joinQueue .. "]")
            chilliJoin(entry.obfJobId)

            task.spawn(function()
                local obfAtStart = entry.obfJobId
                task.wait(8)
                if currentObfId == obfAtStart and queueBusy then
                    debugLog("Timeout: " .. entry.name .. ", skipping")
                    queueBusy    = false
                    currentObfId = nil
                end
            end)
        end
        task.wait(0.05)
    end
end)

-- =============================================
-- COLORS / GRADIENTS
-- =============================================
local COLORS = {
    Background = Color3.fromRGB(12, 12, 18),
    SectionBG  = Color3.fromRGB(20, 25, 35),
    Stroke     = Color3.fromRGB(255, 0, 0),
    TextWhite  = Color3.fromRGB(255, 255, 255),
    Unselected = Color3.fromRGB(35, 40, 55),
    Tier1      = Color3.fromRGB(255, 0, 0),
    Tier2      = Color3.fromRGB(255, 180, 0),
    Tier3      = Color3.fromRGB(255, 100, 0),
    Tier4      = Color3.fromRGB(255, 0, 60)
}

local GRADIENT_RED = {
    ColorSequenceKeypoint.new(0,   Color3.fromRGB(255, 0, 0)),
    ColorSequenceKeypoint.new(0.5, Color3.fromRGB(255, 255, 255)),
    ColorSequenceKeypoint.new(1,   Color3.fromRGB(255, 0, 0))
}

local activeGradients = {}
local function applyAnimatedGradient(obj, colors)
    if not (obj:IsA("TextLabel") or obj:IsA("TextButton") or obj:IsA("TextBox") or obj:IsA("UIStroke") or obj:IsA("Frame")) then return end
    local grad = Instance.new("UIGradient")
    grad.Color    = type(colors) == "table" and ColorSequence.new(colors) or colors
    grad.Rotation = 45
    grad.Parent   = obj
    table.insert(activeGradients, grad)
    return grad
end

RunService.RenderStepped:Connect(function()
    for _, grad in ipairs(activeGradients) do
        if grad.Parent then grad.Rotation = (grad.Rotation + 2) % 360 end
    end
end)

-- =============================================
-- GUI
-- =============================================
local function safeParent(gui)
    if gethui then gui.Parent = gethui()
    elseif typeof(syn) == "table" and syn.protect_gui then syn.protect_gui(gui); gui.Parent = CoreGui
    else pcall(function() gui.Parent = CoreGui end) end
end

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SkFinder_Rexzy"
ScreenGui.ResetOnSpawn = false
safeParent(ScreenGui)

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 340, 0, 380)  -- slightly taller to fit anti-join button
MainFrame.Position = UDim2.new(0.5, -170, 0.5, -190)
MainFrame.BackgroundColor3 = COLORS.Background
MainFrame.BorderSizePixel = 0
MainFrame.ClipsDescendants = true
MainFrame.Parent = ScreenGui
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 26)

local AnimatedStroke = Instance.new("UIStroke")
AnimatedStroke.Thickness = 3.5
AnimatedStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
AnimatedStroke.Parent = MainFrame
local StrokeGradient = Instance.new("UIGradient")
StrokeGradient.Color = ColorSequence.new(COLORS.Stroke)
StrokeGradient.Transparency = NumberSequence.new({
    NumberSequenceKeypoint.new(0, 0), NumberSequenceKeypoint.new(0.4, 0), NumberSequenceKeypoint.new(1, 1)
})
StrokeGradient.Rotation = 45
StrokeGradient.Parent = AnimatedStroke
RunService.RenderStepped:Connect(function()
    if MainFrame.Visible then StrokeGradient.Rotation = StrokeGradient.Rotation + 3 end
end)

local Header = Instance.new("Frame")
Header.Size = UDim2.new(1, 0, 0, 50)
Header.BackgroundTransparency = 1
Header.ZIndex = 10
Header.Parent = MainFrame

local Title = Instance.new("TextLabel")
Title.Text = "Rexzy Joiner"
Title.Font = Enum.Font.GothamBlack
Title.TextSize = 18
Title.TextColor3 = COLORS.TextWhite
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Size = UDim2.new(0.55, 0, 1, 0)
Title.Position = UDim2.new(0, 20, 0, 0)
Title.BackgroundTransparency = 1
Title.Parent = Header
applyAnimatedGradient(Title, GRADIENT_RED)

local QueueBadge = Instance.new("TextLabel")
QueueBadge.Text = "Q: 0"
QueueBadge.Font = Enum.Font.GothamBold
QueueBadge.TextSize = 11
QueueBadge.TextColor3 = COLORS.TextWhite
QueueBadge.BackgroundColor3 = COLORS.SectionBG
QueueBadge.Size = UDim2.new(0, 50, 0, 20)
QueueBadge.Position = UDim2.new(1, -138, 0.5, -10)
QueueBadge.Parent = Header
Instance.new("UICorner", QueueBadge).CornerRadius = UDim.new(0, 6)

local MinBadge = Instance.new("TextLabel")
MinBadge.Text = "Min: 10M/s"
MinBadge.Font = Enum.Font.GothamBold
MinBadge.TextSize = 10
MinBadge.TextColor3 = COLORS.TextWhite
MinBadge.BackgroundColor3 = COLORS.SectionBG
MinBadge.Size = UDim2.new(0, 72, 0, 20)
MinBadge.Position = UDim2.new(1, -138, 0.5, 12)
MinBadge.Parent = Header
Instance.new("UICorner", MinBadge).CornerRadius = UDim.new(0, 6)
applyAnimatedGradient(MinBadge, GRADIENT_RED)

local CloseBtn = Instance.new("TextButton")
CloseBtn.Size = UDim2.new(0, 28, 0, 28)
CloseBtn.Position = UDim2.new(1, -38, 0.5, -14)
CloseBtn.BackgroundColor3 = COLORS.SectionBG
CloseBtn.Text = "X"
CloseBtn.TextColor3 = COLORS.TextWhite
CloseBtn.Font = Enum.Font.GothamBlack
CloseBtn.TextSize = 14
CloseBtn.Parent = Header
Instance.new("UICorner", CloseBtn).CornerRadius = UDim.new(0, 8)

-- =============================================
-- ANTI-JOIN TOGGLE BUTTON (in GUI)
-- =============================================
local AntiJoinBtn = Instance.new("TextButton")
AntiJoinBtn.Size = UDim2.new(1, -20, 0, 30)
AntiJoinBtn.Position = UDim2.new(0, 10, 0, 52)
AntiJoinBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
AntiJoinBtn.Text = "ðŸ”´ Anti-Join: OFF"
AntiJoinBtn.TextColor3 = Color3.fromRGB(255, 100, 100)
AntiJoinBtn.Font = Enum.Font.GothamBold
AntiJoinBtn.TextSize = 12
AntiJoinBtn.ZIndex = 5
AntiJoinBtn.Parent = MainFrame
Instance.new("UICorner", AntiJoinBtn).CornerRadius = UDim.new(0, 8)

local AntiJoinStroke = Instance.new("UIStroke")
AntiJoinStroke.Thickness = 1.5
AntiJoinStroke.Color = Color3.fromRGB(255, 100, 100)
AntiJoinStroke.Parent = AntiJoinBtn

AntiJoinBtn.MouseButton1Click:Connect(function()
    ANTI_JOIN = not ANTI_JOIN
    if ANTI_JOIN then
        AntiJoinBtn.Text = "ðŸŸ¢ Anti-Join: ON  (Teleports Blocked)"
        AntiJoinBtn.TextColor3 = Color3.fromRGB(60, 255, 100)
        AntiJoinStroke.Color = Color3.fromRGB(60, 255, 100)
        AntiJoinBtn.BackgroundColor3 = Color3.fromRGB(20, 50, 30)
        debugLog("ðŸš« Anti-Join ENABLED â€” teleports blocked")
    else
        AntiJoinBtn.Text = "ðŸ”´ Anti-Join: OFF"
        AntiJoinBtn.TextColor3 = Color3.fromRGB(255, 100, 100)
        AntiJoinStroke.Color = Color3.fromRGB(255, 100, 100)
        AntiJoinBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
        debugLog("âœ… Anti-Join DISABLED â€” teleports allowed")
    end
end)

-- =============================================
-- COLUMN HEADERS  (shifted down to make room for anti-join btn)
-- =============================================
local ColHeader = Instance.new("Frame")
ColHeader.Size = UDim2.new(1, -20, 0, 28)
ColHeader.Position = UDim2.new(0, 10, 0, 88)  -- was 52, shifted +36
ColHeader.BackgroundTransparency = 1
ColHeader.Parent = MainFrame

local ColName = Instance.new("TextLabel")
ColName.Text = "Pet Name"
ColName.Font = Enum.Font.GothamBold
ColName.TextColor3 = COLORS.TextWhite
ColName.TextSize = 12
ColName.BackgroundTransparency = 1
ColName.Size = UDim2.new(0.48, 0, 1, 0)
ColName.Position = UDim2.new(0.02, 0, 0, 0)
ColName.TextXAlignment = Enum.TextXAlignment.Left
ColName.Parent = ColHeader
applyAnimatedGradient(ColName, GRADIENT_RED)

local ColMoney = Instance.new("TextLabel")
ColMoney.Text = "Money/s"
ColMoney.Font = Enum.Font.GothamBold
ColMoney.TextColor3 = COLORS.TextWhite
ColMoney.TextSize = 12
ColMoney.BackgroundTransparency = 1
ColMoney.Size = UDim2.new(0.22, 0, 1, 0)
ColMoney.Position = UDim2.new(0.5, 0, 0, 0)
ColMoney.TextXAlignment = Enum.TextXAlignment.Left
ColMoney.Parent = ColHeader
applyAnimatedGradient(ColMoney, GRADIENT_RED)

local ColPlayers = Instance.new("TextLabel")
ColPlayers.Text = "Players"
ColPlayers.Font = Enum.Font.GothamBold
ColPlayers.TextColor3 = COLORS.TextWhite
ColPlayers.TextSize = 12
ColPlayers.BackgroundTransparency = 1
ColPlayers.Size = UDim2.new(0.16, 0, 1, 0)
ColPlayers.Position = UDim2.new(0.72, 0, 0, 0)
ColPlayers.TextXAlignment = Enum.TextXAlignment.Left
ColPlayers.Parent = ColHeader
applyAnimatedGradient(ColPlayers, GRADIENT_RED)

local ScrollContainer = Instance.new("Frame")
ScrollContainer.Size = UDim2.new(1, -20, 1, -124)  -- adjusted for extra height
ScrollContainer.Position = UDim2.new(0, 10, 0, 118)
ScrollContainer.BackgroundTransparency = 1
ScrollContainer.ClipsDescendants = true
ScrollContainer.Parent = MainFrame

local LogScroll = Instance.new("ScrollingFrame")
LogScroll.Name = "LogScroll"
LogScroll.Size = UDim2.new(1, 0, 1, 0)
LogScroll.BackgroundTransparency = 1
LogScroll.ScrollBarThickness = 3
LogScroll.ScrollBarImageColor3 = COLORS.Stroke
LogScroll.BorderSizePixel = 0
LogScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
LogScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
LogScroll.Parent = ScrollContainer

local LogListLayout = Instance.new("UIListLayout")
LogListLayout.SortOrder = Enum.SortOrder.LayoutOrder
LogListLayout.Padding = UDim.new(0, 4)
LogListLayout.Parent = LogScroll

local MiniFrame = Instance.new("Frame")
MiniFrame.Name = "MiniFrame"
MiniFrame.Size = UDim2.new(0, 220, 0, 36)
MiniFrame.Position = UDim2.new(0.5, -110, 0.05, 0)
MiniFrame.BackgroundColor3 = COLORS.Background
MiniFrame.Visible = false
MiniFrame.Parent = ScreenGui
Instance.new("UICorner", MiniFrame).CornerRadius = UDim.new(1, 0)
local MiniStroke = Instance.new("UIStroke")
MiniStroke.Thickness = 2
MiniStroke.Color = COLORS.Stroke
MiniStroke.Parent = MiniFrame
applyAnimatedGradient(MiniStroke, GRADIENT_RED)

local MiniTitle = Instance.new("TextLabel")
MiniTitle.Text = "Rexzy Joiner"
MiniTitle.Font = Enum.Font.GothamBold
MiniTitle.TextColor3 = COLORS.TextWhite
MiniTitle.TextSize = 12
MiniTitle.BackgroundTransparency = 1
MiniTitle.Size = UDim2.new(0, 110, 1, 0)
MiniTitle.Position = UDim2.new(0, 15, 0, 0)
MiniTitle.TextXAlignment = Enum.TextXAlignment.Left
MiniTitle.Parent = MiniFrame
applyAnimatedGradient(MiniTitle, GRADIENT_RED)

local MiniQBadge = Instance.new("TextLabel")
MiniQBadge.Text = "Q:0"
MiniQBadge.Font = Enum.Font.GothamBold
MiniQBadge.TextSize = 11
MiniQBadge.TextColor3 = COLORS.TextWhite
MiniQBadge.BackgroundTransparency = 1
MiniQBadge.Size = UDim2.new(0, 35, 1, 0)
MiniQBadge.Position = UDim2.new(1, -62, 0, 0)
MiniQBadge.Parent = MiniFrame

local MiniOpenBtn = Instance.new("TextButton")
MiniOpenBtn.Size = UDim2.new(0, 26, 0, 26)
MiniOpenBtn.Position = UDim2.new(1, -32, 0.5, -13)
MiniOpenBtn.BackgroundColor3 = COLORS.SectionBG
MiniOpenBtn.Text = "O"
MiniOpenBtn.TextColor3 = COLORS.TextWhite
MiniOpenBtn.Font = Enum.Font.GothamBold
MiniOpenBtn.TextSize = 14
MiniOpenBtn.Parent = MiniFrame
Instance.new("UICorner", MiniOpenBtn).CornerRadius = UDim.new(1, 0)

local function updateQueueBadge()
    local n = #joinQueue
    QueueBadge.Text = "Q: " .. n
    QueueBadge.BackgroundColor3 = n > 0 and Color3.fromRGB(200, 60, 0) or COLORS.SectionBG
    MiniQBadge.Text = "Q:" .. n
end

local function makeDraggable(topbar, frame)
    local dragging, dragInput, dragStart, startPos = false, nil, nil, nil
    topbar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true; dragStart = input.Position; startPos = frame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    topbar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end
makeDraggable(Header, MainFrame)
makeDraggable(MiniFrame, MiniFrame)

local function toggleMinimize()
    if MainFrame.Visible then
        MainFrame.Visible = false
        MiniFrame.Visible = true
        MiniFrame.Position = UDim2.new(0, MainFrame.AbsolutePosition.X + (MainFrame.AbsoluteSize.X/2 - MiniFrame.AbsoluteSize.X/2), 0, MainFrame.AbsolutePosition.Y)
    else
        MiniFrame.Visible = false
        MainFrame.Visible = true
        MainFrame.Position = UDim2.new(0, MiniFrame.AbsolutePosition.X - (MainFrame.AbsoluteSize.X/2 - MiniFrame.AbsoluteSize.X/2), 0, MiniFrame.AbsolutePosition.Y)
    end
end

CloseBtn.MouseButton1Click:Connect(toggleMinimize)
MiniOpenBtn.MouseButton1Click:Connect(toggleMinimize)
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.RightControl then toggleMinimize() end
end)

RunService.Heartbeat:Connect(updateQueueBadge)

-- =============================================
-- CREATE LOG
-- =============================================
local logSortCounter = 0

local function createLog(data)
    pcall(function()
        local moneyM   = data.moneyM   or 0
        local petName  = data.name     or "Unknown"
        local obfJobId = data.jobid    or ""
        local moneyStr = data.moneyStr or formatMoney(moneyM)
        local players  = data.players  or "?"

        local tierColor = COLORS.Tier1
        if moneyM >= 100 then tierColor = COLORS.Tier4
        elseif moneyM >= 50 then tierColor = COLORS.Tier3
        elseif moneyM >= 15 then tierColor = COLORS.Tier2 end

        local row = Instance.new("Frame")
        row.Name = "row_" .. obfJobId:sub(1, 20)
        row.Size = UDim2.new(1, 0, 0, 36)
        row.BackgroundColor3 = Color3.new(1, 1, 1)
        row.BorderSizePixel = 0
        row.ClipsDescendants = true
        row.Parent = LogScroll
        Instance.new("UICorner", row).CornerRadius = UDim.new(0, 6)

        local rowGrad = Instance.new("UIGradient")
        rowGrad.Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.fromRGB(20, 20, 30)),
            ColorSequenceKeypoint.new(1, tierColor)
        })
        rowGrad.Parent = row

        local shimmer = Instance.new("Frame")
        shimmer.Size = UDim2.new(0, 40, 2, 0)
        shimmer.Position = UDim2.new(-0.2, 0, -0.5, 0)
        shimmer.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        shimmer.BackgroundTransparency = 1
        shimmer.Rotation = 25
        shimmer.ZIndex = 2
        shimmer.Parent = row
        local sg = Instance.new("UIGradient")
        sg.Color = ColorSequence.new(Color3.new(1, 1, 1))
        sg.Transparency = NumberSequence.new{
            NumberSequenceKeypoint.new(0, 1), NumberSequenceKeypoint.new(0.5, 0.85), NumberSequenceKeypoint.new(1, 1)
        }
        sg.Parent = shimmer
        TweenService:Create(shimmer, TweenInfo.new(2.5, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut, -1), {
            Position = UDim2.new(1.2, 0, -0.5, 0)
        }):Play()

        local rName = Instance.new("TextLabel")
        rName.Name = "PetNameLabel"
        rName.Text = petName
        rName.Size = UDim2.new(0.46, 0, 1, 0)
        rName.Position = UDim2.new(0.02, 0, 0, 0)
        rName.BackgroundTransparency = 1
        rName.TextColor3 = tierColor
        rName.Font = Enum.Font.GothamBold
        rName.TextSize = 12
        rName.TextXAlignment = Enum.TextXAlignment.Left
        rName.TextTruncate = Enum.TextTruncate.AtEnd
        rName.ZIndex = 3
        rName.Parent = row

        local rMoney = Instance.new("TextLabel")
        rMoney.Text = moneyStr
        rMoney.Size = UDim2.new(0.2, 0, 1, 0)
        rMoney.Position = UDim2.new(0.48, 0, 0, 0)
        rMoney.BackgroundTransparency = 1
        rMoney.TextColor3 = tierColor
        rMoney.Font = Enum.Font.GothamBold
        rMoney.TextSize = 11
        rMoney.TextXAlignment = Enum.TextXAlignment.Left
        rMoney.ZIndex = 3
        rMoney.Parent = row

        local rPlayers = Instance.new("TextLabel")
        rPlayers.Text = players
        rPlayers.Size = UDim2.new(0.16, 0, 1, 0)
        rPlayers.Position = UDim2.new(0.68, 0, 0, 0)
        rPlayers.BackgroundTransparency = 1
        rPlayers.TextColor3 = Color3.fromRGB(180, 200, 255)
        rPlayers.Font = Enum.Font.GothamBold
        rPlayers.TextSize = 11
        rPlayers.TextXAlignment = Enum.TextXAlignment.Left
        rPlayers.ZIndex = 3
        rPlayers.Parent = row

        local joinBtn = Instance.new("TextButton")
        joinBtn.Size = UDim2.new(0, 38, 0, 24)
        joinBtn.Position = UDim2.new(1, -44, 0.5, -12)
        joinBtn.BackgroundColor3 = COLORS.Stroke
        joinBtn.Text = "JOIN"
        joinBtn.Font = Enum.Font.GothamBlack
        joinBtn.TextSize = 10
        joinBtn.TextColor3 = Color3.new(0, 0, 0)
        joinBtn.ZIndex = 3
        joinBtn.Parent = row
        Instance.new("UICorner", joinBtn).CornerRadius = UDim.new(0, 4)
        joinBtn.MouseButton1Click:Connect(function()
            jobDataCache[obfJobId] = { name = petName, moneyStr = moneyStr, players = players, placeId = data.placeId or game.PlaceId }
            currentObfId = obfJobId
            queueBusy    = true
            chilliJoin(obfJobId)
        end)

        logSortCounter = logSortCounter - 1
        row.LayoutOrder = logSortCounter
    end)
end

-- =============================================
-- API POLL
-- =============================================
local function fetchServers()
    local ok, response = pcall(function() return game:HttpGet(API_URL) end)
    if not ok or not response or response == "" then return end

    local ok2, data = pcall(function() return HttpService:JSONDecode(response) end)
    if not ok2 or type(data) ~= "table" then return end

    local servers = data.servers
    if type(servers) ~= "table" then return end

    if not firstPollDone then
        for _, server in ipairs(servers) do
            if type(server) == "table" and type(server.data) == "table" then
                local jobId = server.data.job_id
                if jobId then seenJobIds[jobId] = true end
            end
        end
        firstPollDone = true
        debugLog("First poll seeded " .. #servers .. " jobs â€” ready!")
        return
    end

    for _, server in ipairs(servers) do
        if type(server) == "table" and type(server.data) == "table" then
            local sd      = server.data
            local jobId   = sd.job_id
            local petName = sd.brainrot_name
            local moneyM  = getMoneyInMillions(sd)
            local pid     = sd.place_id or game.PlaceId
            local players = sd.players or "?"

            if jobId and petName and petName ~= "" and not seenJobIds[jobId] then
                seenJobIds[jobId] = true

                local moneyStr = cleanMoneyStr(sd.money, moneyM)

                createLog({ name = petName, jobid = jobId, moneyM = moneyM, moneyStr = moneyStr, players = players, placeId = pid })

                if moneyM >= MIN_MONEY_M then
                    table.insert(joinQueue, {
                        obfJobId = jobId,
                        name     = petName,
                        moneyStr = moneyStr,
                        players  = players,
                        placeId  = pid
                    })
                    updateQueueBadge()
                    debugLog("Queued: " .. petName .. " " .. moneyStr .. " [Q=" .. #joinQueue .. "]")
                end
            end
        end
    end

    local list = {}
    for k in pairs(seenJobIds) do table.insert(list, k) end
    if #list > 500 then
        for i = 1, #list - 500 do seenJobIds[list[i]] = nil end
    end
end

task.spawn(function()
    while true do pcall(fetchServers); task.wait(POLL_RATE) end
end)

debugLog("Polling every 0.3s | min 10M/s queue")

-- =============================================
-- QUEUE ON TELEPORT
-- =============================================
local queueFunc = nil
pcall(function() if queue_on_teleport then queueFunc = queue_on_teleport end end)
if not queueFunc then
    pcall(function()
        if typeof(syn) == "table" and syn.queue_on_teleport then queueFunc = syn.queue_on_teleport end
    end)
end
if queueFunc then
    Players.LocalPlayer.OnTeleport:Connect(function(State)
        if State == Enum.TeleportState.Started or State == Enum.TeleportState.InProgress then
            pcall(function()
                queueFunc('loadstring(game:HttpGet("https://raw.githubusercontent.com/seuusuario/seurepo/main/skfinder.lua"))()')
            end)
        end
    end)
    debugLog("Queue on teleport: active")
else
    debugLog("Queue on teleport: N/A")
end
